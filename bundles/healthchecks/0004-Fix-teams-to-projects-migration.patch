From 2bc48e9846959f4faecd1930ece95fb028ca1c23 Mon Sep 17 00:00:00 2001
From: Jakub Jirutka <jakub@jirutka.cz>
Date: Tue, 28 Jan 2020 18:35:28 +0100
Subject: [PATCH 4/5] Fix teams to projects migration

Make all the projects created from the teams owned by the admin user
and remove legacy team users.
---
 .../migrations/0018_auto_20190112_1426.py     |  6 ++---
 .../migrations/0020_auto_20190112_1950.py     |  6 ++++-
 .../migrations/0024_auto_20190119_1540.py     | 25 ++++++++++++++++---
 hc/api/migrations/0055_auto_20190112_1427.py  |  8 ++++++
 4 files changed, 38 insertions(+), 7 deletions(-)

diff --git a/hc/accounts/migrations/0018_auto_20190112_1426.py b/hc/accounts/migrations/0018_auto_20190112_1426.py
index 6817e1f..dd98f25 100644
--- a/hc/accounts/migrations/0018_auto_20190112_1426.py
+++ b/hc/accounts/migrations/0018_auto_20190112_1426.py
@@ -9,8 +9,8 @@ def create_projects(apps, schema_editor):
     Member = apps.get_model("accounts", "Member")
     for profile in Profile.objects.all():
         project = Project()
-        project.name = profile.team_name
-        project.owner_id = profile.user_id
+        project.name = profile.team_name or "Personal"
+        project.owner_id = 1 if profile.team_name else profile.user_id  # XXX: make admin owner of all migrated teams
         project.api_key = profile.api_key
         project.api_key_readonly = profile.api_key_readonly
         project.save()
@@ -18,7 +18,7 @@ def create_projects(apps, schema_editor):
         profile.current_project = project
         profile.save()
 
-        Member.objects.filter(team=profile).update(project=project)
+        Member.objects.filter(team=profile, project_id__isnull=True).update(project=project, team_id=project.owner_id)
 
     for profile in Profile.objects.all():
         if profile.current_team_id:
diff --git a/hc/accounts/migrations/0020_auto_20190112_1950.py b/hc/accounts/migrations/0020_auto_20190112_1950.py
index a781a19..c1f3d90 100644
--- a/hc/accounts/migrations/0020_auto_20190112_1950.py
+++ b/hc/accounts/migrations/0020_auto_20190112_1950.py
@@ -5,8 +5,12 @@ from django.db import migrations
 
 def set_badge_key(apps, schema_editor):
     Project = apps.get_model("accounts", "Project")
+    Profile = apps.get_model("accounts", "Profile")
     for project in Project.objects.select_related("owner").all():
-        project.badge_key = project.owner.username
+        if Profile.objects.filter(team_name=project.name).exists():
+            project.badge_key = project.name
+        else:
+            project.badge_key = project.owner.username
         project.save()
 
 
diff --git a/hc/accounts/migrations/0024_auto_20190119_1540.py b/hc/accounts/migrations/0024_auto_20190119_1540.py
index 4718920..6ce5285 100644
--- a/hc/accounts/migrations/0024_auto_20190119_1540.py
+++ b/hc/accounts/migrations/0024_auto_20190119_1540.py
@@ -1,13 +1,32 @@
 # Generated by Django 2.1.5 on 2019-01-19 15:40
 
+from django.conf import settings
 from django.db import migrations
 
 
+def delete_team_users(apps, schema_editor):
+    Profile = apps.get_model("accounts", "Profile")
+    for profile in Profile.objects.exclude(team_name__exact=""):
+        profile.user.delete()
+
+
 class Migration(migrations.Migration):
+    atomic = False
 
-    dependencies = [("accounts", "0023_auto_20190117_1419")]
+    dependencies = [
+        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
+        ("accounts", "0023_auto_20190117_1419"),
+        ("api", "0057_auto_20190118_1319"),
+    ]
 
     operations = [
-        migrations.RemoveField(model_name="profile", name="current_team"),
-        migrations.RemoveField(model_name="profile", name="team_name"),
+        migrations.RunPython(delete_team_users, migrations.RunPython.noop, atomic=False),
+        migrations.RemoveField(
+            model_name="profile",
+            name="current_team",
+        ),
+        migrations.RemoveField(
+            model_name="profile",
+            name="team_name",
+        ),
     ]
diff --git a/hc/api/migrations/0055_auto_20190112_1427.py b/hc/api/migrations/0055_auto_20190112_1427.py
index a84f77e..3e0c57b 100644
--- a/hc/api/migrations/0055_auto_20190112_1427.py
+++ b/hc/api/migrations/0055_auto_20190112_1427.py
@@ -5,11 +5,19 @@ from django.db import migrations
 
 def fill_project_id(apps, schema_editor):
     Project = apps.get_model("accounts", "Project")
+    Profile = apps.get_model("accounts", "Profile")
     Check = apps.get_model("api", "Check")
     Channel = apps.get_model("api", "Channel")
     for project in Project.objects.all():
         Check.objects.filter(user_id=project.owner_id).update(project=project)
         Channel.objects.filter(user_id=project.owner_id).update(project=project)
+    for profile in Profile.objects.exclude(team_name__exact=''):
+        try:
+            project = Project.objects.get(name=profile.team_name)
+            Check.objects.filter(user_id=profile.user_id).update(project=project)
+            Channel.objects.filter(user_id=profile.user_id).update(project=project)
+        except Project.DoesNotExist:
+            pass
 
 
 class Migration(migrations.Migration):
-- 
2.24.1

