# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=wluma
pkgver=4.1.1
pkgrel=0
pkgdesc="Automatic brightness adjustment based on screen contents and ALS"
url="https://github.com/maximbaz/wluma"
# riscv64, s390x: blocked by rust/cargo
# arm*, x86: fails to build due to crappy v4l crate
arch="aarch64 ppc64le x86_64"
license="ISC"
makedepends="
	cargo
	cargo-patch
	clang
	eudev-dev
	v4l-utils-dev
	wayland-dev
	vulkan-loader-dev
	"
install="$pkgname.post-install"
source="https://github.com/maximbaz/wluma/archive/$pkgver/wluma-$pkgver.tar.gz
	cargo.patch
	use-linked-vulkan.patch

	v4l-01-fix-string-pointer-cast.cargo-patch
	v4l-02-fix-wrong-_IOC_TYPE-on-musl.cargo-patch
	"

# wayland-client/use_system_lib - link to libwayland-client.so instead of using Rust impl.
_cargo_opts="--features wayland-client/use_system_lib"

prepare() {
	default_prepare

	# Optimize binary for size.
	cat >> Cargo.toml <<-EOF

		[profile.release]
		codegen-units = 1
		lto = true
		opt-level = "s"
		#panic = "abort"
	EOF

	cargo patch
	cargo fetch --locked
}

build() {
	cargo build $_cargo_opts --locked --release
}

check() {
	cargo test $_cargo_opts --frozen
}

package() {
	install -D -m755 target/release/wluma -t "$pkgdir"/usr/bin/
	install -D -m644 90-wluma-backlight.rules -t "$pkgdir"/lib/udev/rules.d/
}

sha512sums="
8804645da2ef14f3764b878cf60a9590a72977f8428786b6cfb637781c8d60e66bbaacdcee97014982c92363f8f087763fe0617d5f0959127ac64a66f3b8bebc  wluma-4.1.1.tar.gz
3d1e36938d93af5db0843a41d371bda1cbdf93474eef5ba6ec1fdd72fb476b7f0b7e46bbcc642d7c84876e42efc4050dcb889efa27b229d9385f0b59708a92c0  cargo.patch
7f8ac2b05ed33f3b1be6ca85db17a58abfea425640f99ec12ddf85f59fe65c10be34a4e18d6726be3618c8271612791909f2a48b21972085c94cd3c50417ce74  use-linked-vulkan.patch
cd9e718a2950b71039e2be15c004f5236667fab2025766759e56f46454e24d845b863d400f8655bd2a40e1a4b2366307e263eff714db85062dab8c68df10a838  v4l-01-fix-string-pointer-cast.cargo-patch
b19d53e00859005d2a91cc6d0d99450e753bbce3b5843e26d0153ddbe38835346dea580988573bd1c7230effe5a260889bc3b82b71dfba2a6d9106253f62dc0e  v4l-02-fix-wrong-_IOC_TYPE-on-musl.cargo-patch
"
