# Contributor: Sean McAvoy <seanmcavoy@gmail.com>
# Maintainer: Sean McAvoy <seanmcavoy@gmail.com>
pkgname=greetd
pkgver=0.8.0
pkgrel=0
pkgdesc="Minimal and flexible login manager daemon"
url="https://git.sr.ht/~kennylevinsen/greetd"
arch="all !mips64 !s390x !riscv64"  # limited by cargo/rust
license="GPL-3.0-only"
makedepends="cargo linux-pam-dev scdoc"
install="$pkgname.pre-install"
pkgusers="greetd"
pkggroups="greetd"
subpackages="$pkgname-doc $pkgname-openrc $pkgname-agreety"
source="$pkgname-$pkgver.tar.gz::https://git.sr.ht/~kennylevinsen/greetd/archive/$pkgver.tar.gz
	$pkgname.pam
	$pkgname.initd
	$pkgname.confd
	001-change-greetd-runas.patch
	"
builddir="$srcdir/$pkgname-$pkgver"

export RUSTFLAGS="--remap-path-prefix=$builddir=/build/"

build() {
	cargo build --release --locked

	local dst src
	for src in man/*.scd; do
		dst=${src%.scd}; dst=${dst%-*}.${dst##*-}  # foo-1.scd -> foo.1
		scdoc < $src > $dst
	done

}

check() {
	cargo check --locked
}

package() {
	install -Dm755 target/release/greetd "$pkgdir"/usr/sbin/greetd
	install -Dm755 target/release/agreety "$pkgdir"/usr/bin/agreety

	install -Dm644 config.toml "$pkgdir"/etc/greetd/config.toml
	install -Dm644 "$srcdir"/$pkgname.pam "$pkgdir"/etc/pam.d/$pkgname

	install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname

	local i; for i in man/*.[0-9]; do
		install -Dm644 $i "$pkgdir"/usr/share/man/man${i##*.}/${i##*/}
	done
}

agreety() {
	pkgdesc="Simple, text-based greeter"
	depends="$pkgname"

	amove usr/bin/agreety
}

sha512sums="
40f007e38ca41faac97b3faba60e49d524c9e3afb4b594fcbc04a129701fa6177a915b2998e61f0ca615f4c8bd3078ef9fbd562c8fb72298f5605efd75a3f370  greetd-0.8.0.tar.gz
7e52d2404f9ae393721a471b7b113effa969404253f730c1360001923742a1b84e131db33d988399dae93a788db33dc1bb40e22272cd6a31c0e94cfceb47ed8a  greetd.pam
b3a035901fa2ec5a1652e9c9660d204f074b68311508464976cdf70925f2614c8eb0866563f2b09257bd5b79cb149e12abe723abce4911ce6668d4f1bc4582ba  greetd.initd
f6c5d5755fb8cca3d45d6879557fb7fc85c40879bc570e6c9aac462ce9133a2fa0a03cbac1e598f8162a9136d3e6020cea808e16e1797f4d37d4cf7dfc94c11c  greetd.confd
90a8b0e836fa29dd143ba08b0f9824403acddda2c964217e999aef2272ad7acda2da2b914ee35db7a365423cc0fccfb61521df7b6519fa9e5b6356ff1ae8b801  001-change-greetd-runas.patch
"
